---
name: Build Trackma Standalone Executable
on:
  push:
    branches:
      - main
  workflow_dispatch: null
jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3-pip \
            python3-venv \
            git \
            patchelf  # Necesario para PyInstaller en Linux
          python3 -m pip install --upgrade pip wheel
      - name: Clone and version detection
        run: |
          git clone --depth 1 https://github.com/z411/trackma.git trackma-source
          cd trackma-source
          VERSION=$(grep -m1 version pyproject.toml | awk -F\" '{print $2}')
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "Project version: ${VERSION}"
      - name: Install Python dependencies
        run: |
          cd trackma-source
          python3 -m pip install \
            pyinstaller \
            -e .  # Instala trackma y sus dependencias
      - name: Build executable
        run: |
          cd trackma-source
          pyinstaller \
            --onefile \
            --name trackma \
            --distpath ../dist \
            --add-data="trackma/data:data" \
            --hidden-import="pkg_resources" \
            --clean \
            trackma/__main__.py

          # Verificar que el binario existe
          if [ ! -f "../dist/trackma" ]; then
            echo "::error::Build failed! Executable not found"
            exit 1
          fi
      - name: Prepare release package
        run: >
          mkdir -p release

          mv dist/trackma release/


          # Crear archivo de versiÃ³n

          echo "${VERSION}" > release/VERSION


          # Empaquetar todo

          tar -czvf "trackma-${VERSION}-linux-amd64.tar.gz" -C release .

          echo "ARTIFACT_PATH=trackma-${VERSION}-linux-amd64.tar.gz" >> $GITHUB_ENV


          # Mostrar estructura

          echo "Package contents:"

          tar -tzvf "${ARTIFACT_PATH}"
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: trackma-standalone
          path: ${{ env.ARTIFACT_PATH }}
