---
name: Build Trackma Standalone (GTK Bundle)
on:
  push:
    branches:
      - main
  workflow_dispatch: null
jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3-pip \
            python3-venv \
            git \
            patchelf \
            libcairo2-dev \
            libgirepository1.0-dev \
            gir1.2-gtk-3.0 \
            python3-gi \
            python3-gi-cairo \
            python3-cairo
          python3 -m pip install --upgrade pip wheel
      - name: Clone and setup
        run: >
          git clone --recursive https://github.com/z411/trackma.git trackma-source

          cd trackma-source

          VERSION=$(grep -m1 version pyproject.toml | awk -F\" '{print $2}')

          echo "VERSION=${VERSION}" >> $GITHUB_ENV


          # Instalar con extras GTK + trackers

          python3 -m pip install -e .[gtk,trackers]
      - name: Build GTK executable
        run: >
          cd trackma-source


          # Obtener rutas de forma robusta

          DATA_PATH=$(python3 -c "import trackma; import os; print(os.path.join(os.path.dirname(trackma.__file__), 'data')")

          ENTRY_POINT=$(python3 -c "from trackma.ui.gtk import TrackmaGTK; import inspect; print(inspect.getfile(TrackmaGTK))")


          echo "🔍 Detected:"

          echo "Data path: ${DATA_PATH}"

          echo "Entry point: ${ENTRY_POINT}"


          # Construir el ejecutable

          pyinstaller \
            --onefile \
            --name trackma-gtk \
            --distpath ../dist \
            --add-data="${DATA_PATH}:data" \
            --hidden-import="pkg_resources" \
            --hidden-import="gi" \
            --hidden-import="cairo" \
            --hidden-import="jeepney" \
            --clean \
            "${ENTRY_POINT}"

          # Verificación exhaustiva

          if [ ! -f "../dist/trackma-gtk" ]; then
            echo "::error::❌ Build failed!"
            echo "📁 Directory contents:"
            ls -la ../dist/
            echo "📜 Build logs:"
            cat build/trackma-gtk/warn-trackma-gtk.txt
            exit 1
          fi


          echo "✅ Build successful!"

          ls -lh "../dist/trackma-gtk"
      - name: Package release
        run: >
          mkdir -p release

          mv dist/trackma-gtk release/


          # Incluir metadatos

          echo "version: ${VERSION}" > release/info.yml

          echo "build_date: $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> release/info.yml


          # Empaquetar con estructura clara

          tar -czvf "trackma-${VERSION}-gtk-linux.tar.gz" -C release .


          # Generar checksum

          sha256sum "trackma-${VERSION}-gtk-linux.tar.gz" > "trackma-${VERSION}-gtk-linux.sha256"


          echo "ARTIFACT_PATH=trackma-${VERSION}-gtk-linux.tar.gz" >> $GITHUB_ENV

          echo "📦 Package ready:"

          ls -lh *.tar.gz *.sha256
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: trackma-gtk-portable
          path: |
            ${{ env.ARTIFACT_PATH }}
            trackma-${VERSION}-gtk-linux.sha256
