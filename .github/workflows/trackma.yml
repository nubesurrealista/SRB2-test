name: Build GNU Icecat (Debian/Ubuntu Way)

on:
  workflow_dispatch:

jobs:
  build-icecat:
    runs-on: ubuntu-latest

    steps:
      - name: Instalar dependencias
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip clang llvm pkg-config \
            libasound2-dev libpulse-dev cbindgen nodejs libxkbcommon-dev \
            libpango1.0-dev libx11-xcb-dev libxrandr-dev libxcomposite-dev \
            libxcursor-dev libxdamage-dev libxfixes-dev libxi-dev libxtst-dev \
            nasm libgtk-3-dev libdbus-glib-1-dev checkinstall git

      - name: Clonar GNUzilla
        run: |
          git clone https://git.savannah.gnu.org/git/gnuzilla.git

      - name: Ejecutar makeicecat
        run: |
          cd gnuzilla
          ./makeicecat

      - name: Crear .mozconfig mínimo
        run: |
          cd gnuzilla/output
          ICECATDIR=$(find . -maxdepth 1 -type d -name "icecat-*")
          if [ -z "$ICECATDIR" ]; then
            echo "No se encontró carpeta icecat-*, abortando."
            exit 1
          fi
          mkdir -p "$ICECATDIR/icecat"
          cat <<EOF > "$ICECATDIR/icecat/.mozconfig"
ac_add_options --enable-application=browser
ac_add_options --prefix=/usr
ac_add_options --enable-official-branding
ac_add_options --disable-debug
ac_add_options --disable-tests
mk_add_options MOZ_OBJDIR=@TOPSRCDIR@/obj-icecat
EOF

      - name: Configurar Icecat
        run: |
          cd gnuzilla/output
          ICECATDIR=$(find . -maxdepth 1 -type d -name "icecat-*")
          cd "$ICECATDIR/icecat"
          ./mach configure

      - name: Compilar Icecat
        run: |
          cd gnuzilla/output
          ICECATDIR=$(find . -maxdepth 1 -type d -name "icecat-*")
          cd "$ICECATDIR/icecat"
          ./mach build

      - name: Empaquetar Icecat
        run: |
          cd gnuzilla/output
          ICECATDIR=$(find . -maxdepth 1 -type d -name "icecat-*")
          cd "$ICECATDIR/icecat"
          ./mach package

      - name: Construir .deb con checkinstall
        run: |
          cd gnuzilla/output
          ICECATDIR=$(find . -maxdepth 1 -type d -name "icecat-*")
          OBJDIR=$(find "$ICECATDIR/icecat" -maxdepth 1 -type d -name "obj-*")
          if [ -z "$OBJDIR" ]; then
            echo "No se encontró obj-*, abortando."
            exit 2
          fi
          cd "$OBJDIR"
          sudo checkinstall --install=no --pkgname=icecat --pkgversion=$(basename "$ICECATDIR" | cut -d- -f2) --default

      - name: Subir artefactos
        uses: actions/upload-artifact@v4
        with:
          name: icecat-artifacts
          path: |
            gnuzilla/output/icecat-*/icecat/obj-*/icecat*.deb
            gnuzilla/output/icecat-*/icecat/obj-*/icecat*.tar.*
