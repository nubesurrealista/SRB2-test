name: Build GNU Icecat (Debian/Ubuntu Way)

on:
  workflow_dispatch:

jobs:
  build-icecat:
    runs-on: ubuntu-latest

    steps:
      - name: Instalar dependencias
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip clang llvm pkg-config \
            libasound2-dev libpulse-dev cbindgen nodejs libxkbcommon-dev \
            libpango1.0-dev libx11-xcb-dev libxrandr-dev libxcomposite-dev \
            libxcursor-dev libxdamage-dev libxfixes-dev libxi-dev libxtst-dev \
            nasm libgtk-3-dev libdbus-glib-1-dev checkinstall git

      - name: Clonar GNUzilla
        run: |
          git clone https://git.savannah.gnu.org/git/gnuzilla.git

      - name: Ejecutar makeicecat
        run: |
          cd gnuzilla
          ./makeicecat

      - name: Configurar Icecat (copiar .mozconfig y configurar)
        run: |
          cd gnuzilla/output
          icecatdir=$(find . -maxdepth 1 -type d -name "icecat-*")
          cp ../data/buildscripts/*.mozconfig $icecatdir/icecat/.mozconfig
          cd $icecatdir/icecat
          ./mach configure

      - name: Compilar Icecat
        run: |
          cd gnuzilla/output
          icecatdir=$(find . -maxdepth 1 -type d -name "icecat-*")
          cd $icecatdir/icecat
          ./mach build

      - name: Empaquetar Icecat
        run: |
          cd gnuzilla/output
          icecatdir=$(find . -maxdepth 1 -type d -name "icecat-*")
          cd $icecatdir/icecat
          ./mach package

      - name: Construir .deb con checkinstall
        run: |
          cd gnuzilla/output
          icecatdir=$(find . -maxdepth 1 -type d -name "icecat-*")
          objdir=$(find $icecatdir -type d -name "obj-*")
          cd $objdir
          sudo checkinstall --install=no --pkgname=icecat --pkgversion=$(basename $icecatdir | cut -d- -f2) --default

      - name: Subir artefactos
        uses: actions/upload-artifact@v4
        with:
          name: icecat-artifacts
          path: |
            gnuzilla/output/icecat-*/icecat/obj-*/icecat*.deb
            gnuzilla/output/icecat-*/icecat/obj-*/icecat*.tar.*
